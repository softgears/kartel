@using Kartel.Domain.Entities
@using Kartel.Domain.Interfaces.Repositories
@using Kartel.Domain.IoC
@using Kartel.Trade.Web.Classes.Utils
@model Kartel.Domain.Entities.Category

@{
    ViewBag.Title = "Тендеры в категории " + Model.Title;
    Layout = "../Shared/_Layout.cshtml";
    int page = ViewBag.page;
    var totalPages = MathHelper.PagesCount(Model.GetTenders().Count(), 20);
    var countries = Locator.GetService<ICountriesRepository>().GetAllCountries();
    string currentRegion = ViewBag.CurrentRegion;
    var currentCountry = countries.FirstOrDefault(c => c.Code == currentRegion);
    string subregion = ViewBag.subregion;
    IEnumerable<Tender> tenders = ViewBag.tenders;
    var banners = Locator.GetService<IBannersRepository>().FindAll()
        .Where(f => string.IsNullOrEmpty(f.Html) & f.Img != null & f.Extra == "5")
        .OrderBy(f => f.Sort)
        .ToList();
    ViewBag.metaKeywords = Model.GetMetaString(currentCountry, page, totalPages , subregion);
    ViewBag.metaDescription = Model.GetMetaString(currentCountry, page, totalPages, subregion);
}

@* Хлебная крошка *@
@Html.Partial("NavigationChain")

<div id="page-tenders">
    <div class="tenders-banner">
        @Html.Partial("Banners",banners)
    </div>
    <div class="tenders-center">
        <div class="hr-block">
            Страница @(page + 1) из @totalPages
        </div>

        @foreach (var tender in tenders)
        {
            <div class="tender">
                <div class="tender-date">
                    @if (tender.DateCreated.HasValue)
                    {
                        <span class="day">@tender.DateCreated.Value.Day</span><br />@tender.DateCreated.Value.ToString("MMMM")<br />@tender.DateCreated.Value.Year <text>год</text>
                    }
                </div>
                <div class="tender-details">
                    <div class="tender-title">
                        <a href="/tenders/tender/@tender.Id">@tender.Title</a>
                    </div>
                    <div class="desc">
                        @tender.Description
                    </div>
                    <div class="location">
                        @tender.User.City, @tender.User.Country
                    </div>
                </div>
            </div>
        }

        <div class="hr-block">
            Страница @(page + 1) из @totalPages
        </div>

        @* Пагинатор *@
        @if (totalPages > 1)
        {
            <div id="paginator">
                @for (var i = 0; i < totalPages; i++)
                {
                    if (i == page)
                    {
                    <span class="current-page">@(page + 1)</span>
                    }
                    else
                    {
                    <a href="/tenders/category/@Model.Id?page=@(i)&region=@currentRegion">@(i + 1)</a>
                    }
                }
            </div>
        }
    </div>
    <div class="tenders-filter">
        <div class="title">
            Регион
        </div>
        <ul class="countries">
            <li>
                <a href="/tenders/category/@Model.Id">Все регионы</a>
            </li>
            @foreach (var c in countries)
            {
                <li>
                    <img src="@c.Flag"/><a href="/tenders/category/@Model.Id?region=@c.Code">@c.Name</a>
                    @if (c.Name == "Россия")
                    {
                        <div class="region-select">
                            Регион: 
                            <select id="sub-region">
                                <option></option>
                                <option>Адыгея</option>
                                <option>Алтайский край</option>
                                <option>Амурская обл.</option>
                                <option>Архангельская обл.</option>
                                <option>Астраханская обл.</option>
                                <option>Башкортостан</option>
                                <option>Белгородская обл.</option>
                                <option>Брянская обл.</option>
                                <option>Бурятия</option>
                                <option>Владимирская обл.</option>
                                <option>Волгоградская обл.</option>
                                <option>Вологодская обл.</option>
                                <option>Воронежская обл.</option>
                                <option>Дагестан</option>
                                <option>Забайкальский край.</option>
                                <option>Ивановская обл.</option>
                                <option>Иркутская обл.</option>
                                <option>Калининградская обл.</option>
                                <option>Калужская обл.</option>
                                <option>Калмыкия</option>
                                <option>Камчатская обл.</option>
                                <option>Карелия</option>
                                <option>Кемеровская обл.</option>
                                <option>Кировская обл.</option>
                                <option>Коми</option>
                                <option>Костромская обл.</option>
                                <option>Краснодарский край</option>
                                <option>Красноярский край</option>
                                <option>Курганская обл.</option>
                                <option>Курская обл.</option>
                                <option>Ленинградская обл.</option>
                                <option>Липецкая обл.</option>
                                <option>Магаданская обл.</option>
                                <option>Марий Эл</option>
                                <option>Мордовия</option>
                                <option>Московская обл.</option>
                                <option>Мурманская обл.</option>
                                <option>Нижегородская обл.</option>
                                <option>Новгородская обл.</option>
                                <option>Новосибирская обл.</option>
                                <option>Омская обл.</option>
                                <option>Оренбургская обл.</option>
                                <option>Орловская обл.</option>
                                <option>Пензенская обл.</option>
                                <option>Пермская обл.</option>
                                <option>Приморский край</option>
                                <option>Псковская обл.</option>
                                <option>Ростовская обл.</option>
                                <option>Рязанская обл.</option>
                                <option>Самарская обл.</option>
                                <option>Санкт-Петербург</option>
                                <option>Саратовская обл.</option>
                                <option>Сахалинская обл.</option>
                                <option>Саха (Якутия)</option>
                                <option>Свердловская обл.</option>
                                <option>Северная Осетия</option>
                                <option>Смоленская обл.</option>
                                <option>Ставропольский край</option>
                                <option>Тамбовская обл.</option>
                                <option>Татарстан</option>
                                <option>Тверская обл.</option>
                                <option>Томская обл.</option>
                                <option>Тульская обл.</option>
                                <option>Тюменская обл.</option>
                                <option>Удмуртская Респ.</option>
                                <option>Ульяновская обл.</option>
                                <option>Хабаровский край</option>
                                <option>Хакасия</option>
                                <option>Ханты-Мансийский а.о.</option>
                                <option>Челябинская обл.</option>
                                <option>Чувашская Респ.</option>
                                <option>Ямало-Ненецкий а.о.</option>
                                <option>Ярославская обл.</option>
                            </select>
                        </div>
                    }
                </li>
            }
        </ul>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function() {
        $(".region-select").find("option").each(function(index, item) {
            $(item).val($(item).text());
        });
        $("#sub-region").val('@subregion').change(function () {
            var newVal = $(this).val();
            if (newVal == "") {
                window.location.href = '/tenders/category/@Model.Id?region=@currentRegion&subregion=';
        }
            window.location.href = '/tenders/category/@Model.Id?region=@currentRegion&subregion=' + newVal;
        });
    });
</script>